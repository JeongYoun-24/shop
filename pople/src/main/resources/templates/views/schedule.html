<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http//www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout2}">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
<title>예매 페이지</title>
    <style>
    body{
    font-family: 'Lato', sans-serif;
    background-color: #242333;
    color: #fff;
    box-sizing: border-box;
}

#container{
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 800px;

}

.movieContainer{
    margin: 20px 0px;
}

.showcase{
    background-color: #777;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 5px;
    display: flex;
    justify-content: center;
    margin: 16px 0;
    padding: 5px 10px;
}

.movieContainer select{
    margin: 10px;
    padding: 5px 15px 5px 15px;
    border-radius: 7px;
    appearance: none;
    border: 0;
}

.movieContainer select option{

   text-align: left;
}

li{
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: 10px;
}

.small{
    color: #777;
    margin-left: 2px;
}

.showcase .seat:hover{
    cursor: default;
    scale: 1;
}

.showcase .selectedSeat:hover{
    cursor: default;
    scale: 1;
}

.screen{
   background-color: #fff;
   margin: 25px;
   padding: 5px;
   width: 140px;
   height: 80px;
   transform: rotateX(-45deg);
   box-shadow: 0 3px 10px rgb(255 255 255 / 70%);
}

.seat{
    background-color: #444451;
    width: 15px;
    height: 12px;
    margin: 3px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    cursor: pointer;
}

.availableSeat{
    background-color: #444451;
    width: 15px;
    height: 12px;
    margin: 3px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    cursor: default;
}

.selectedSeatIcon{
    background-color: #6feaf6;
    width: 15px;
    height: 12px;
    margin: 3px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    cursor: default;
}

.seat:hover{
    scale: 1.2;
}

.selectedSeat:hover{
    scale: 1.2;
}

.seat:nth-of-type(2){
    margin-right: 18px;
}

.seat:nth-of-type(7){
    margin-left: 18px;
}

.occupiedSeat:nth-of-type(2){
    margin-right: 18px;
}
.occupiedSeat:nth-of-type(7){
    margin-left: 18px;
}

.selectedSeat{
    background-color: #6feaf6;
    width: 15px;
    height: 12px;
    margin: 3px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    cursor: pointer;
}

.occupiedSeat{
    background-color: #fff;
    width: 15px;
    height: 12px;
    margin: 3px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

.row{
    display: flex;
}

.text{
    margin-top: 30px;
    padding: 20px;
}

#count{
    color: #6feaf6;
}

#costs{
    color: #6feaf6;
}

  </style>
</head>


<div layout:fragment="content" class="m-3 p-3">

    <!-- 리스트 -->
    <div class="row mt-3">
        <div class="col">

            <div class="card">
<!--                [[${cinema}]]-->
<!--                <hr>-->
<!--                [[${seat}]]-->
                
                <!-- <div>
                    <div class="row">
                        //대표 이미지
                        <div class="col-md-4">
                            <div>
                                <img  th:src="${movie.movieImgDTOList[0].imgUrl}" style="width:300px;" class="rounded m-auto d-block" alt="" >

                            </div>

                        </div>
                        <div class="col-md-2"></div>


                        <div class="col-md-5">
                            
                            <span th:if="${movie.movieStatus == T(com.springboot.pople.constant.MovieStatus).OPEN}">개봉</span>
                            <span th:unless="${movie.movieStatus == T(com.springboot.pople.constant.MovieStatus).OPEN}">미개봉 </span>
                            <div class="h4" th:text="${movie.movieName}"></div>
                            <hr class="my-4">
                            
                            <div>
                                <div>
                                    <input type="hidden" th:value="${movie.id}" id="movieid" name="movieid" class="form-control">

                                </div>
                                <div class="input-group mb-3 mt-2">
                                    <h5>관람등급</h5>
                                    <hr class="">
                                </div>
                                <div>
                                    [[${movie.movieRating}]]
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="text-right  d-flex ">
                                <h5>러닝타임(상영시간)</h5>
                                <hr class="">
                            </div>
                            <div>
                                [[${movie.movieTime}]]
                            </div>

                            <hr class="my-4">
                            <div class="text-right  d-flex ">
                                <h5>개봉일자</h5>
                                <hr class="">
                            </div>
                            <div>
                                [[${movie.movieDate}]]
                            </div>



                        </div>
                        
                        <hr class="my-4">


                    </div>

                </div> -->
                <input type="hidden" id="movieid" th:value="${movie.id}">
                <input type="hidden" id="movieName" th:value="${movie.movieName}">
                <input type="hidden" id="movieTime" th:value="${movie.movieTime}">
                <input type="text" id="userid" sec:authorize="isAuthenticated()" th:value="${#authentication.principal.username}">

                <li class="nav-item"  sec:authorize="isAuthenticated()"><span>[[${#authentication.principal.username}]]님</span> </li>




                <h5 class="card-header text-center">영화 예매 페이지 </h5>
                <div class="card-body">
                    <div class="d-flex justify-content-center">
                        <div >
                            <label>상영시간</label>
                            <select id="scheduleid" class="cinemaHeader" name="addrssY"  >
                                <option >상영시간 선택</option>
                                <option  th:value="${schedule.id}" th:each="schedule, status: ${schedule}">[[${schedule.startTime}]]==[[${schedule.dayTime}]]</option>

                            </select>


                        </div>


                        <label>지역선택</label>
                        <select id="addrssY" class="cinemaHeader" name="addrssY" >
                            <option  value="">양산</option>

                        </select>

                        <label>영화관</label>
                        <select id="cinemaid" class="cinemaHeader" name="cinemaid" >
                            <option >영화관 선택</option>
                            <option  th:name="id" th:value="${cinema.cinemaid}" th:each="cinema, status: ${cinema}">[[${cinema.cinemaName}]]</option>

                        </select>

                        <div class="d-flex" id="qqqq2">

                        </div>
                        <select id="qqqq" class="mx-2">
                        </select>
                        <button id="seatBtn" type="button" class="btn btn-outline-dark text-center" style="height: 30px;" data-bs-toggle="modal" data-bs-target="#exampleModal">
                            좌석표 보기
                        </button>

<!--                            [[${theater}]]-->
                    </div>
                    <div id="" class="d-flex justify-content-center">

<!--                        <a href="#none" onclick=" window.open('modHistory_pop.html', 'new', toolbar=no, menubar=no, scrollbars=yes, resizable=no, width=700, height=700, left=0, top=0 );return false">클릭</a>-->
                        <!-- Button trigger modal -->


                        <div id="seat">

                        </div>






                        <!-- 결제 금액 -->
                        <div class="d-flex  justify-content-end my-2">
                            <div>
                                <p class="text">선택좌석 <span id="count2">0</span>좌석  총가격<span id="costs2">0</span>원</p>

                            </div>


                        </div>
                        <div class="d-flex justify-content-center">
                            <button id="ticktingBtn"> 확인 </button>
                        </div>

                    </div>




                </div>
                <div class="d-flex justify-content-center">
                    <button class="" id="gBtn">지도 활성화</button>
                    <button class="" id="gBtn2">지도 비활성화</button>
                </div>
                <div class="d-flex justify-content-center">
                    <div>
                        <select id="cinemaAddrss" class="cinemaHeader" name="cinemaAddrss" >
                            <option >영화관 주소</option>
                            <option  th:name="id" th:value="${cinema.cinemaid}" th:each="cinema, status: ${cinema}">[[${cinema.cinemaName}]]</option>

                        </select>
                    </div>
                </div>
                <div id="mapClass" class="d-flex justify-content-center">



                    <div style="width:800px; height:400px;" id="map"></div>
                </div>



            </div>

        </div>



    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">좌석표 </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #242444;">
                    <div>
                                <div id="container">
                                    <div class="movieContainer">
                                        <label for="movie">
                                            티켓 가격:
                                        </label>
                                        <select name="pickMovie" id="movie">
                                            <option class="price" value="11000">(2D) 11000원</option>
                                            <option class="price" value="15000">(3D) 15000원</option>

                                        </select>
                                    </div>
                                    <ul class="showcase">
                                        <li>
                                            <div class="availableSeat"></div>
                                            <small class="small">선택 가능</small>
                                        </li>
                                        <li>
                                            <div class="selectedSeatIcon"></div>
                                            <small class="small">선택 좌석</small>
                                        </li>
                                        <li>
                                            <div class="occupiedSeat"></div>
                                            <small class="small">선택 불가능</small>
                                        </li>
                                    </ul>

                                    <div class="seatContainer">
                                        <div class="screen"></div>
                                        <div class=" row " id="setatBody">A


                                        </div>
                                        <div class="row">B
                                            <span class="seat" id="seatid1B" value="1B" >1B</span>
                                            <span class="seat" id="seatid2B" value="2B">2B</span>
                                            <span class="seat" id="seatid3B" value="3B">3B</span>
                                            <span class="seat" id="seatid4B" value="4B">4B</span>
                                            <span class="seat" id="seatid5B" value="5B">5B</span>
                                            <span class="seat" id="seatid6B" value="6B">6B</span>
                                            <span class="seat" id="seatid7B" value="7B">7B</span>
                                            <span class="seat" id="seatid8B" value="8B">8B</span>
                                            <span class="seat" id="seatid9B" value="9B">9B</span>
                                            <span class="seat" id="seatid10B" value="10B">10B</span>
                                        </div>

                                        <div class="row">C
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                        </div>

                                        <div class="row">D
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                        </div>

                                        <div class="row">E
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                        </div>

                                        <div class="row">F
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                        </div>

                                        <div class="row">G
                                            <span class="seat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="occupiedSeat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                            <span class="seat"></span>
                                        </div>

                                    </div>

                                    <p class="text">선택좌석 <span id="count">0</span> 총가격  <span id="costs">0</span>원</p>


                    </div>



                    </div>



                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary"  id="DBtn" data-bs-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>



</div>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>




<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5d685fba38c1258790f7835cd29a04c2,clusterer,drawing"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:src="@{/js/cinema.js}"></script>
<script layout:fragment="script"    th:inline="javascript">
 document.addEventListener('DOMContentLoaded', () =>{

const seatContainer = document.querySelector('.seatContainer');

const movie = document.getElementById('movie'); // 선택할 영화
let moviePrice = Number(movie.value); // 영화과격

let count = document.querySelector('#count'); // 인원수
let costs = document.querySelector('#costs'); // 가격

let seatid1B = document.querySelector('#seatid1B');
let seatid2B = document.querySelector('#seatid2B');
let seatid3B = document.querySelector('#seatid3B');
let seatid4B = document.querySelector('#seatid4B');
let seatid5B = document.querySelector('#seatid5B');
let seatid6B = document.querySelector('#seatid6B');
let seatid7B = document.querySelector('#seatid7B');
let seatid8B = document.querySelector('#seatid8B');
let seatid9B = document.querySelector('#seatid9B');
let seatid10B = document.querySelector('#seatid10B');

// 선택한 좌석수 텍스트 변경해주기

function countSeatPrice(){
    const selectedSeatCount = document.querySelectorAll('.selectedSeat').length;

    count.textContent = selectedSeatCount;
    costs.textContent = selectedSeatCount * moviePrice;

    count.value = selectedSeatCount;
    costs.value = selectedSeatCount * moviePrice;

   seatV.value = seatid1B.value;


}


//좌석 클릭했을때

seatContainer.addEventListener('click', (e) => {

    if(e.target.className === 'seat'){
        e.target.className = 'selectedSeat';
    } else if(e.target.className === 'selectedSeat'){
        e.target.className = 'seat';
    }

    countSeatPrice();
})

// 영화 변경할때

movie.addEventListener('change', (e) => {

    moviePrice = Number(e.target.value);

    countSeatPrice()

})



})













    $('#price').hide();



        //$('#map').hide();
        $('#gBtn2').hide();
        $('#seatBtn').hide();
        $('#ticktingBtn').hide();

        $('#gBtn').click(function(){

            $('#map').show();
            $('#gBtn2').show();
            $('#gBtn').hide();

        })
     $('#gBtn2').click(function(){
         $('#gBtn').show();
          $('#gBtn2').hide();
          $('#map').hide();


     })
  $('#cinemaAddrss').change(function(){
        var cinemaid = $('#cinemaAddrss').val()
        console.log(cinemaid)
        var data = {
                cinemaid : $('#cinemaAddrss').val()

                };

        $.ajax({  //페이지가 아닌 데이터만 보내기
                type: "POST",
                async: true, //true=비동기
                url: "/schedule/cinemaid",
               // dataType : "text", //서버로부터 받은 데이터 타입
                data:JSON.stringify(data), //매개변수
                contentType: "application/json; charset=utf-8",
                 success: function(data) {
                console.log(data);
                    if(data != null){
                    var x = data.xaxis;
                    var y = data.yaxis;
                        console.log(x);
                        console.log(y);

                        const container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스

                        let options = { //지도를 생성할 때 필요한 기본 옵션
                        center: new kakao.maps.LatLng(x, y), //지도의 중심좌표.
                        level: 1 //지도의 레벨(확대, 축소 정도)
                        };
                        let map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

                        $('#map').show();
                        $('#gBtn2').show();
                        $('#gBtn').hide();
                    }




                 },
                error: function(){

                },
                complete : function(){

                }


            }) //end



  })





    $('#addrss').hide()
    $('#theaterid').hide()


           $('#cinemaid').change(function(){
           var cinemaid = $('#cinemaid').val()
           var qqqq = $('#qqqq').val()

                $('#addrss').show()
                $('#theaterid').show()

                console.log([[${theater}]])
                console.log([[${cinema}]])
                console.log([[${seat}]])
                console.log("체인지")
                console.log(cinemaid)
                console.log(qqqq)

                var data = {
                cinemaid : $('#cinemaid').val()

                };

                $.ajax({  //페이지가 아닌 데이터만 보내기
                type: "POST",
                async: true, //true=비동기
                url: "/theater/cinemaFind",
               // dataType : "json", //서버로부터 받은 데이터 타입
                data:JSON.stringify(data), //매개변수
                contentType: "application/json; charset=utf-8",
                 success: function(data) {
                
                    for(var i = 0; i < data.length; i++){
                    console.log(data[i]);
                    const id = data[i].id;
                    var cid = data[i]["id"]
                        console.log(cid);
                         //var r = "<select  class=''  >";
                           var r= "<option "
                           r += "value="+cid
                           r +=  ">"
                             r+= data[i].id +"상영관"

                            r+= "</option>"

                          // r+= "</select>";




                             var r2 = "<input type='hidden'"
                                r2 += "value="+data[i].id

                                r2 += ">"

                       $("#qqqq").append(r);
	   	            $("#qqqq2").append(r2);

	            }


                      },
                error: function(){

                },
                complete : function(){

                }
            }) //end

           })

        $('#qqqq').change(function(){
            var qqqq = $('#qqqq').val()
            console.log(qqqq);

            var data = {
                theaterid : $('#qqqq').val()

                };

                $.ajax({  //페이지가 아닌 데이터만 보내기
                type: "POST",
                async: true, //true=비동기
                url: "/schedule/theaterid",
               // dataType : "json", //서버로부터 받은 데이터 타입
                data:JSON.stringify(data), //매개변수
                contentType: "application/json; charset=utf-8",
                 success: function(data) {
                           //var lain = "<label class='mx-1'>"
                             //   lain += data[1].seatLineNo
                             // lain+=  "</label>"
                   // $("#setatBody").append(lain);
                    for(var i = 0; i < data.length; i++){
                        var seatNo = data[i].seatNo
                        var seatBtn = "seatBtn";
                        console.log(data[i])

                            
                        var r =  "<span class='seat'"
                           
                            r += "id="+seatBtn+seatNo
                            r += ">"
                            r+= seatNo
                            r +=  "</span>"


                        $("#setatBody").append(r);
	                    }

                      },
                error: function(){

                },
                complete : function(){

                }
            }) //end
            $('#seatBtn').show();



        })
$(function(){
        $('#DBtn').click(function(){
           console.log("예매하기")
            var count = $('#count').val(); // 인원수
            var costs = $('#costs').val() // 가격
            console.log(count)
            console.log(costs)

                $('#count2').text(count)
                $('#costs2').text(costs)
            $('#ticktingBtn').show();

        })
        $('#ticktingBtn').click(function(){
            var count = $('#count').val(); // 인원수
            var costs = $('#costs').val(); // 가격
            var cinemaid = $('#cinemaid').val();
            var theaterid = $('#qqqq').val()
            var movieid = $('#movieid').val();
            var movieName = $('#movieName').val();
            var movieTime = $('#movieTime').val();
            var scheduleid = $('#scheduleid').val();


             console.log(count)
            console.log(costs)
              console.log(cinemaid)
            console.log(theaterid)
              console.log(movieid)
              console.log(movieName)
              console.log(movieTime)
             var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

         var data = {
            count : $('#count').val(),
            costs : $('#costs').val(),
            cinemaid : $('#cinemaid').val(),
            theaterid : $('#qqqq').val(),
            movieid : $('#movieid').val(),
            movieName : $('#movieName').val(),
            movieTime : $('#movieTime').val(),
            userName : $('#userid').val(),
            scheduleid : $('#scheduleid').val()

            };



            $.ajax({  //페이지가 아닌 데이터만 보내기
                type: "POST",
                async: true, //true=비동기
                url: "/tickting/form",
                dataType : "text", //서버로부터 받은 데이터 타입
                data:JSON.stringify(data), //매개변수
                contentType: "application/json; charset=utf-8",
                 success: function(data,status) {
                    alert("예매가 완료 되었습니다.");
                    location.href='/main';

                      },
                error:function(jqXHR, status, error){
                        if(jqXHR.status == '401'){
                        alert('로그인 후 이용해주세요');
                        location.href='/users/login';
                    } else{
                        alert(jqXHR.responseText);
                        alert('로그인 후 이용해주세요');
                        location.href='/users/login';
                    }

                },
                complete : function(){

                }


         })

        })

    })







</script>
<style  layout:fragment="css"       th:inline="css">
        .clearBtn {
            margin-left: 0.3em;
        }

        .pagination a {
            cursor: pointer;
        }
        .btn-outline-dark:hover{

        }


    </style>
</html>
